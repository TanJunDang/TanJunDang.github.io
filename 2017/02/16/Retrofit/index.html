<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="Build a better app.">
    

    <!--Author-->
    
        <meta name="author" content="TanJunDang">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Retrofit笔记"/>
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="TanJunDang"/>

    <!--Page Cover-->
    
        <meta property="og:image" content="undefined"/>
    

    <!-- Title -->
    
    <title>Retrofit笔记 - TanJunDang</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/main.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <!--Favicon-->
    

</head>

<body>

<!-- Menu -->
<!-- Navigation -->
<header>
    <div class="logo">
        <a href="/">TanJunDang</a>
    </div><!-- end logo -->

    <div id="menu_icon"></div>
    <nav>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives">Archives</a>
            </li>
            
        </ul>
    </nav><!-- end navigation menu -->

    <div class="footer clearfix">
        <ul class="social clearfix">
            
            
                <li><a href="https://www.facebook.com/" class="fb" target="_blank" data-title="Facebook"></a></li>
            
            
                <li><a href="https://www.behance.net/" class="behance" target="_blank" data-title="Behance"></a></li>
            
            
                <li><a href="https://plus.google.com/+Pixelhint/posts" class="google" target="_blank" data-title="Google+"></a></li>
            
            
                <li><a href="https://dribbble.com/pixelhint" class="dribble" target="_blank" data-title="Dribble"></a></li>
            
            
            
            
        </ul><!-- end social -->

        <div class="rights">
            <p>Copyright © 2014 magnetic.</p>
            <p>Template by <a href="http://pixelhint.com/magnetic-free-html5-responsive-photography-website-template/">Pixelhint.com</a></p>
            <p>Hexo Theme by <a href="http://www.codeblocq.com/">Jonathan K.</a></p>
        </div><!-- end rights -->
    </div ><!-- end footer -->
</header><!-- end header -->


<!-- Main Content -->
<section class="main clearfix">

    <section class="top" style="background: url('http://placehold.it/1300x500');">
        <div class="wrapper content_header clearfix">
            

<div class="work_nav">

    <ul class="btn clearfix">
        
        <li><a href="/2017/02/16/Project-Network/" class="previous" data-title="Android框架设计 - 网络层"></a></li>
        
        <li><a href="/" class="grid" data-title="Portfolio"></a></li>
        
        <li><a href="/2017/02/09/Project-BaseApplication/" class="next" data-title="Android架构 - BaseA..."></a></li>
        
    </ul>

</div><!-- end work_nav -->
            <h1 class="title">Retrofit笔记</h1>
        </div>
    </section><!-- end top -->

    <section class="wrapper">
        <div class="content">

            <!-- Gallery -->
            

            <!-- Content -->
            <h1 id="Retrofit2-0的理解"><a href="#Retrofit2-0的理解" class="headerlink" title="Retrofit2.0的理解"></a>Retrofit2.0的理解</h1><blockquote>
<p>待添加的库<br>compile ‘com.squareup.retrofit2:retrofit:2.2.0’<br>compile ‘com.squareup.retrofit2:converter-gson:2.1.0’</p>
</blockquote>
<a id="more"></a>
<h2 id="Query的用法"><a href="#Query的用法" class="headerlink" title="Query的用法"></a>Query的用法</h2><blockquote>
<p>URL格式<br><a href="http://v.juhe.cn/weixin/query?pno=1&amp;ps=5&amp;dtype=&amp;key=c24de664fed8f7d8e25790cc0c6e0637" target="_blank" rel="external">http://v.juhe.cn/weixin/query?pno=1&amp;ps=5&amp;dtype=&amp;key=c24de664fed8f7d8e25790cc0c6e0637</a></p>
<p>Query会将参数拼接在问号”?”后面</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 定义接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TianGouApi</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 因为在这里pno、ps是变化的所以需使用@query标识符</span></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"query?dtype=&amp;key=c24de664fed8f7d8e25790cc0c6e0637"</span>)</span><br><span class="line">    Call&lt;HomeFragment.TianGouResp&gt; getWeChat(<span class="meta">@Query</span>(<span class="string">"pno"</span>) <span class="keyword">int</span> page, <span class="meta">@Query</span>(<span class="string">"pagesize"</span>) <span class="keyword">int</span> pagesize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">String url = <span class="string">"http://v.juhe.cn/weixin/"</span>;</span><br><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()  <span class="comment">//01:获取Retrofit对象</span></span><br><span class="line">        .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">        .baseUrl(url) <span class="comment">//02采用链式结构绑定Base url</span></span><br><span class="line">        .build();<span class="comment">//03执行操作</span></span><br><span class="line"></span><br><span class="line">TianGouApi tianGouApi = retrofit.create(TianGouApi.class);</span><br><span class="line">Call&lt;TianGouResp&gt; call = tianGouApi.getWeChat(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">call.enqueue(<span class="keyword">new</span> Callback&lt;TianGouResp&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;TianGouResp&gt; call, Response&lt;TianGouResp&gt; response)</span> </span>&#123;</span><br><span class="line">        LogTool.e(<span class="string">"tiangou"</span>, response.body());</span><br><span class="line">        list.addAll(response.body().getTngou());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;TianGouResp&gt; call, Throwable t)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Path用法"><a href="#Path用法" class="headerlink" title="Path用法"></a>Path用法</h2><blockquote>
<p>理解<br>path用于取代某个字段</p>
<p>URL格式<br><a href="http://wuxiaolong.me/2016/01/15/retrofit/" target="_blank" rel="external">http://wuxiaolong.me/2016/01/15/retrofit/</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TianGouApi</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"2016/01/15/&#123;business&#125;"</span>)</span><br><span class="line">    Call&lt;HomeFragment.TianGouResp&gt; getWeChat(<span class="meta">@Path</span>(<span class="string">"business"</span>) String business);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>##　FieldMap用法</p>
<blockquote>
<p>理解<br>可以用map的方式提交参数</p>
<p>在Retrofit接口中定义相关API方法，参数声明为map<br>定义一个存放map方法的Api类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NetworkService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FormUrlEncoded</span></span><br><span class="line">    <span class="meta">@POST</span>(<span class="string">"iov_gw/api"</span>)</span><br><span class="line">    <span class="function">Observable&lt;JsonObject&gt; <span class="title">request</span><span class="params">(@FieldMap Map&lt;String, Object&gt; paraMap)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Api</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">sendValiCode2Phone</span><span class="params">(String phone, String type)</span> </span>&#123;</span><br><span class="line">      Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">      params.put(<span class="string">"api"</span>, RequestAction.REGISTER_GET_CODE);</span><br><span class="line">      params.put(<span class="string">"phone"</span>, phone);</span><br><span class="line">  <span class="comment">//        if (!StringUtil.isEmpty(type)) &#123;</span></span><br><span class="line">  <span class="comment">//            params.put("type", type);</span></span><br><span class="line">  <span class="comment">//        &#125;</span></span><br><span class="line">      <span class="keyword">return</span> params;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Header用法"><a href="#Header用法" class="headerlink" title="Header用法"></a>Header用法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Call&lt;Object&gt; <span class="title">updateInfo</span><span class="params">(@Header(<span class="string">"device"</span>)</span> String device, @<span class="title">Header</span><span class="params">(<span class="string">"version"</span>)</span> <span class="keyword">int</span> version,</span><br><span class="line">                        @<span class="title">Field</span><span class="params">(<span class="string">"id"</span>)</span> String id)</span>;</span><br></pre></td></tr></table></figure>
<h1 id="Retrofit的使用"><a href="#Retrofit的使用" class="headerlink" title="Retrofit的使用"></a>Retrofit的使用</h1><blockquote>
<p>Get请求<br>Get请求结合Query一起使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GET</span>(<span class="string">"order/updateToPending.json"</span>)</span><br><span class="line"><span class="function">Call&lt;HttpBaseBean&gt; <span class="title">getPedingOrder</span><span class="params">(@Query(<span class="string">"orderId"</span>)</span> <span class="keyword">long</span> orderId)</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>POST请求<br>Post结合Field、FormUrlEncoded一起使用<br>上传json必须用post</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FormUrlEncoded</span></span><br><span class="line"><span class="meta">@POST</span>(<span class="string">"order/cart/add.json"</span>)</span><br><span class="line"><span class="function">Call&lt;HttpBaseBean&gt; <span class="title">addToCar</span><span class="params">(@Field(<span class="string">"cartJson"</span>)</span> String cartJson)</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>文件上传<br>Post集合Multipart使用。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图片上传</span></span><br><span class="line"><span class="meta">@Multipart</span></span><br><span class="line"><span class="meta">@POST</span>(<span class="string">"upload.json"</span>)</span><br><span class="line"><span class="function">Call&lt;ImageUploadResp&gt; <span class="title">uploadImage</span><span class="params">(@Part MultipartBody.Part file)</span></span>;    <span class="comment">// 图片上传</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>接口如下<br>|名称|类型|说明|<br>|–|<br>|orgId|long|机构ID|<br>|logo|File|图片|</p>
</blockquote>
<p><img src="http://imglf1.nosdn.127.net/img/ZFRpZXBrMUVQR0RtYngydTluemtmZzhvVE1zUFVTekMvbnFsdnNNM3dDSmpOS3hBSXU5aUpnPT0.png?imageView&amp;thumbnail=500x0&amp;quality=96&amp;stripmeta=0&amp;type=jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在API接口里使用@Part MultipartBody.Part参数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Multipart</span></span><br><span class="line"><span class="meta">@POST</span>(<span class="string">"store/eidtHomePageLogo.json"</span>)</span><br><span class="line"><span class="function">Call&lt;HttpBaseBean&gt; <span class="title">editBannerLogo</span><span class="params">(@Query(<span class="string">"orgId"</span>)</span> <span class="keyword">long</span> orgId, @Part MultipartBody.Part file)</span>;</span><br><span class="line"></span><br><span class="line">File file = <span class="keyword">new</span> File(path);</span><br><span class="line">RequestBody requestFile = RequestBody.create(MediaType.parse(Constants.MULTIPART_FROM_DATA), file);</span><br><span class="line"><span class="comment">//这里传递是参数是logo</span></span><br><span class="line">MultipartBody.Part body = MultipartBody.Part.createFormData(<span class="string">"logo"</span>, file.getName(), requestFile);</span><br></pre></td></tr></table></figure>
<h1 id="封装的Retrofit请求工具类"><a href="#封装的Retrofit请求工具类" class="headerlink" title="封装的Retrofit请求工具类"></a>封装的Retrofit请求工具类</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpReqTool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Retrofit retrofit;</span><br><span class="line">    <span class="comment">//    此处修改host</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> CONNECT_TIME_OUT = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> HttpReqTool INSTANCE = <span class="keyword">new</span> HttpReqTool();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpReqTool <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Holder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    HttpReqTool() &#123;</span><br><span class="line">        <span class="keyword">if</span> (retrofit == <span class="keyword">null</span>) &#123;</span><br><span class="line">            retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                    .client(getOKHttpClient())</span><br><span class="line">                    .baseUrl(BuildConfig.BASE_URL_V1)</span><br><span class="line">                    .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                    .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Log打印拦截器</span><br><span class="line">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HttpLogger</span> <span class="keyword">implements</span> <span class="title">HttpLoggingInterceptor</span>.<span class="title">Logger</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">            LogTool.d(LogTool.TAG, getClass().getName() + <span class="string">"\n"</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> OkHttpClient <span class="title">getOKHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OkHttpClient.Builder builder = <span class="keyword">new</span> OkHttpClient().newBuilder();</span><br><span class="line">        HttpLoggingInterceptor logInterceptor = <span class="keyword">new</span> HttpLoggingInterceptor(<span class="keyword">new</span> HttpLogger());</span><br><span class="line">        logInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY);</span><br><span class="line">        builder.addNetworkInterceptor(logInterceptor);</span><br><span class="line"><span class="comment">//        设置超时时间</span></span><br><span class="line">        builder.connectTimeout(CONNECT_TIME_OUT, TimeUnit.SECONDS);</span><br><span class="line">        builder.writeTimeout(CONNECT_TIME_OUT, TimeUnit.SECONDS);</span><br><span class="line">        builder.readTimeout(CONNECT_TIME_OUT, TimeUnit.SECONDS);</span><br><span class="line">        builder.addInterceptor(<span class="keyword">new</span> Interceptor() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                Request request = chain.request();</span><br><span class="line">                <span class="comment">// 添加新的参数</span></span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(Global.TOKEN)) &#123;</span><br><span class="line">                    request = request</span><br><span class="line">                            .newBuilder()</span><br><span class="line">                            .build();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    HttpUrl.Builder authorizedUrlBuilder = request.url()</span><br><span class="line">                            .newBuilder()</span><br><span class="line">                            .scheme(request.url().scheme())</span><br><span class="line">                            .host(request.url().host())</span><br><span class="line">                            .addQueryParameter(Constants.TOKEN, Global.TOKEN)</span><br><span class="line">                            .addQueryParameter(Constants.USER_ID, String.valueOf(Global.getInstance().getUserId()));</span><br><span class="line">                    request = request</span><br><span class="line">                            .newBuilder()</span><br><span class="line">                            .url(authorizedUrlBuilder.build())</span><br><span class="line"><span class="comment">//                        添加头部信息(共同请求参数)</span></span><br><span class="line"><span class="comment">//                            .addHeader(Constants.TOKEN, Global.TOKEN)</span></span><br><span class="line"><span class="comment">//                            .addHeader(Constants.USER_ID, String.valueOf(Global.getInstance().getUserId()))</span></span><br><span class="line">                            .build();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> chain.proceed(request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">createApi</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> retrofit.create(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">createApiWithBaseUrl</span><span class="params">(Class&lt;T&gt; clazz, String baseUrl)</span> </span>&#123;</span><br><span class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                .client(getOKHttpClient())</span><br><span class="line">                .baseUrl(baseUrl)</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> retrofit.create(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 文件下载</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> url      待下载url</span><br><span class="line">     * <span class="doctag">@param</span> savePath 保存路径</span><br><span class="line">     * <span class="doctag">@param</span> fileName 文件名</span><br><span class="line">     * <span class="doctag">@param</span> listener 回调</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fileDownload</span><span class="params">(String url, String savePath, String fileName, FileDownloadListener listener)</span> </span>&#123;</span><br><span class="line">        FileDownloader</span><br><span class="line">                .getImpl()</span><br><span class="line">                .create(url)</span><br><span class="line">                .setPath(savePath + fileName)</span><br><span class="line">                .setListener(listener)</span><br><span class="line">                .start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><blockquote>
<p>使用<br>1.使用Multipart注解及POST注解<br>2.定义MultipartBody.Part 参数<br>3.创建RequestBody、MultipartBody对象。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图片上传</span></span><br><span class="line"><span class="meta">@Multipart</span></span><br><span class="line"><span class="meta">@POST</span>(<span class="string">"upload/image.json"</span>)</span><br><span class="line"><span class="function">Call&lt;ImageUploadResp&gt; <span class="title">uploadImage</span><span class="params">(@Query(<span class="string">"file"</span>)</span> String fileName, @Part MultipartBody.Part file)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(path);</span><br><span class="line">RequestBody requestFile = RequestBody.create(MediaType.parse(<span class="string">"multipart/form-data"</span>), file);</span><br><span class="line">MultipartBody.Part body = MultipartBody.Part.createFormData(<span class="string">"file"</span>, file.getName(), requestFile);</span><br></pre></td></tr></table></figure>
<h1 id="Retrofit嵌套请求"><a href="#Retrofit嵌套请求" class="headerlink" title="Retrofit嵌套请求"></a>Retrofit嵌套请求</h1><blockquote>
<p>背景<br>登录成功后，需通过获得的token来请求七牛的token</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">HttpReqTool</span><br><span class="line">         .getInstance()</span><br><span class="line">         .createApi(BusinessApi.class)</span><br><span class="line">         .login(email, password)</span><br><span class="line">         .flatMap(<span class="keyword">new</span> Function&lt;LoginResp, ObservableSource&lt;QiNiuTokenResp&gt;&gt;() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="function"><span class="keyword">public</span> ObservableSource&lt;QiNiuTokenResp&gt; <span class="title">apply</span><span class="params">(LoginResp resp)</span> </span>&#123;</span><br><span class="line">                 <span class="keyword">if</span> (resp.isSuccess()) &#123;</span><br><span class="line">                  <span class="comment">// 做一些缓存处理</span></span><br><span class="line"></span><br><span class="line">                     <span class="keyword">return</span> HttpReqTool.getInstance().createApi(BusinessApi.class).getQiNiuToken();</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">// 由于是在io线程中做请求，所以error情况下，弹toast要调用runOnUITHread</span></span><br><span class="line">                   runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                           Functions.toast(resp.getMsg());</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line">                     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line">         &#125;)</span><br><span class="line">         <span class="comment">// 下面两句的位置不能放错。</span></span><br><span class="line">         .subscribeOn(Schedulers.io())</span><br><span class="line">         .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">         .subscribe(<span class="keyword">new</span> ApiObserver&lt;QiNiuTokenResp&gt;() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(QiNiuTokenResp resp)</span> </span>&#123;</span><br><span class="line">                 dialog.dismiss();</span><br><span class="line">                 <span class="keyword">if</span> (resp.isSuccess()) &#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     Functions.toast(resp.getMsg());</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(String error)</span> </span>&#123;</span><br><span class="line">                 dialog.dismiss();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br></pre></td></tr></table></figure>
<p><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0915/3460.html" target="_blank" rel="external">URL定义参考</a><br><a href="http://www.cnblogs.com/WuXiaolong/p/5773126.html" target="_blank" rel="external">其他操作符</a><br><a href="http://www.tuicool.com/articles/F7bimy" target="_blank" rel="external">其他用法</a></p>


            <!-- Tags -->
            


<div class="tags">
    <a href="/tags/Retrofit笔记/">Retrofit笔记</a>
</div>



            <!-- Comments -->
            <div>
                




            </div>
        </div><!-- end content -->
    </section>
</section><!-- end main -->

<!-- After footer scripts -->

<!-- jQuery -->
<script src="/js/jquery.js"></script>

<!-- Custom Code -->
<script src="/js/main.js"></script>

<!-- Gallery -->
<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->


</body>

</html>